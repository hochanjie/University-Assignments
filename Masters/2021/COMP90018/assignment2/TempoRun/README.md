# TempoRun

### NoSQL Data Schema (to_be_discussed)

Firebase Realtime Database (NoSQL/JSON) is used for data storage.

```json
{
  "userid": {
    
    "username": "",

    "spotify": {
      "API": "",
      "current_song": "",
      "current_playlist": ""
    },

    "run_history": [
      {
        "date": "",
        "distance": "",
        "steps": "",
        "time_period": ""
      },
      {
        "date": "",
        "distance": "",
        "steps": "",
        "start_time": "",
        "end_time": ""
      }
    ],

    "current_run": {
      "start_time": "",
      "end_time": "",
      "speed": "",
      "steps": ""
    }
  }
}
```

### Data writing and fetching

Writing "username" : "a user's name"

```java
FirebaseDatabase.getInstance().getReference().child("users").child(auth.getUid()).child("username").setValue("a user's name");
```

1. You may use `getInstance("https://tempo-run-default-rtdb.asia-southeast1.firebasedatabase.app")` if it does not work.
2. `auth.getUid()`contains UID for each authenticated user, while you MIGHT need to pass `FirebaseAuth auth`to other activities. Currently `auth` only exists in Register and Login activities, but it is required for accessing database.

Writing whole JSON object under parent node (use hash map)

```java
Map<String, Object> runHistory = new HashMap<String, Object>();
runHistory.put("date", LocalDateTime.now().toString()); // yyyy-MM-dd'T'HH:mm:ss.SSS
runHistory.put("distance", "1000");
runHistory.put("speed", "5");
runHistory.put("steps", "2000");
runHistory.put("start_time", LocalDateTime.now().toString());
runHistory.put("end_time", LocalDateTime.now().toString());

FirebaseDatabase.getInstance().getReference().child("users").child(auth.getUid()).child("run_history").push().updateChildren(runHistory);
```

`push()`is like you pushed inward a child.

```
- run_history
	- xxxxx random id xxxxx (generated by push())
		- attribute name: value
		- attribute name: value
	- xxxxx random id xxxxx (generated by push())
		- attribute name: value
		- attribute name: value
		
- run_history (without push())
	- attribute name: value
	- attribute name: value
```

Read things

```java
// Go to the node you want to read
FirebaseDatabase.getInstance().getReference().child("users").child(auth.getUid()).child(run_history);

runHistoryRef.addValueEventListener(new ValueEventListener() {
    @Override
    public void onDataChange(DataSnapshot dataSnapshot) {
        // Loop is used because there are multiple run records
        // Otherwise you can manipulate with data from dataSnapshot directly
        for (DataSnapshot snapshot: dataSnapshot.getChildren()) {
            
            // A RunDetail object is created based on single data entry
            // You can store these objects in any arraylist
            RunDetail runDetail = snapshot.getValue(RunDetail.class);
            
            // Convertion
            Log.d("Date", runDetail.getDate().toString()); // runDetail.getDate() LocalDataTime object (add .getHour())
            Log.d("Distance", Integer.toString(runDetail.getDistance())); // runDetail.getDistance(), Int object
            Log.d("Speed", Integer.toString(runDetail.getSpeed())); // Int
            Log.d("Steps", Integer.toString(runDetail.getSteps())); // Int
            Log.d("StartTime", runDetail.getStartTime().toString()); // LocalDateTime
            Log.d("EndTime", runDetail.getEndTime().toString()); // LocalDateTime
        }
    }
    
    @Override
    public void onCancelled(DatabaseError error) {
        // Handle errors here
    }
});
```



